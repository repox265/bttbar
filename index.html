<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BTTools - Barcode App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    .scrollbar-hide {
      -ms-overflow-style: none; /* IE and Edge */
      scrollbar-width: none; /* Firefox */
    }
    .result-container pre {
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .shake {
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
      transform: translate3d(0, 0, 0);
      backface-visibility: hidden;
      perspective: 1000px;
    }
    @keyframes shake {
      10%, 90% {
        transform: translate3d(-1px, 0, 0);
      }
      20%, 80% {
        transform: translate3d(2px, 0, 0);
      }
      30%, 50%, 70% {
        transform: translate3d(-4px, 0, 0);
      }
      40%, 60% {
        transform: translate3d(4px, 0, 0);
      }
    }
    .fade-in {
      animation: fadeIn 0.8s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .btn-press {
        transition: transform 0.1s ease, box-shadow 0.1s ease;
    }
    .btn-press:active {
        transform: scale(0.98);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .tab-panel-transition {
      transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    }
    .history-item:hover {
        background-color: #374151; /* bg-gray-700 equivalent */
    }

    /* Light Mode Specific Styles */
    body.light {
      background: #f3f4f6;
      color: #1f2937;
    }
    body.light .bg-gray-900 { background: #f3f4f6; }
    body.light .text-gray-100 { color: #1f2937; }
    body.light .bg-gray-800 { background: #ffffff; }
    body.light .bg-gray-700 { background: #e5e7eb; }
    body.light .text-gray-400 { color: #6b7280; }
    body.light .border-gray-700 { border-color: #d1d5db; }
    body.light .bg-white { background: #111827; }
    body.light .bg-gray-600 { background: #4b5563; }
    body.light .border-gray-600 { border-color: #9ca3af; }
    body.light .from-purple-400 { from: #8b5cf6; }
    body.light .to-pink-600 { to: #ec4899; }
    body.light .bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-stops)); }
    body.light .text-gray-200 { color: #374151; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col min-h-screen">
  
  <!-- Main Container -->
  <div id="main-content" class="fade-in flex-grow flex flex-col items-center justify-start p-4 md:p-8 space-y-6">

    <!-- Header -->
    <header class="relative w-full max-w-lg text-center p-4 bg-gray-800 rounded-xl shadow-lg border border-gray-700">
      <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">
        BTTools v3.8
      </h1>
      <p class="text-sm text-gray-400 mt-1">Sequnce Generator</p>
      <!-- Dark Mode Toggle -->
      <button id="theme-toggle" class="absolute top-4 right-4 p-2 rounded-full bg-gray-700 text-gray-200 hover:bg-gray-600 transition-colors btn-press">
        <svg id="moon-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
        </svg>
        <svg id="sun-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
        </svg>
      </button>
    </header>

    <!-- Modal for messages -->
    <div id="messageModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-gray-800 p-6 rounded-lg shadow-2xl border border-gray-700 w-full max-w-sm text-center transform transition-all duration-300 scale-95 opacity-0">
            <h3 id="modalTitle" class="text-lg font-bold mb-2"></h3>
            <p id="modalMessage" class="text-sm text-gray-300 mb-4"></p>
            <button onclick="hideModal()" class="w-full py-2 px-4 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors btn-press">
                OK
            </button>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="w-full max-w-lg bg-gray-800 rounded-full p-1 flex shadow-inner">
      <button id="find-offset-btn" data-tab="find-offset" class="flex-1 py-2 px-4 rounded-full text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-purple-500 bg-gray-700 text-gray-200">Find Offset</button>
      <button id="generate-btn" data-tab="generate" class="flex-1 py-2 px-4 rounded-full text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-purple-500 hover:bg-gray-700">Generate</button>
      <button id="history-btn" data-tab="history" class="flex-1 py-2 px-4 rounded-full text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-purple-500 hover:bg-gray-700">History</button>
    </div>

    <!-- Tab Content Container -->
    <div id="tab-container" class="w-full max-w-lg p-6 bg-gray-800 rounded-2xl shadow-xl border border-gray-700">

      <!-- Find Effective Offset Tab -->
      <div id="find-offset-tab" class="tab-panel tab-panel-transition space-y-5">
        <div>
          <label class="block text-sm font-medium text-gray-400 mb-1">Date</label>
          <input type="date" id="dateInput1" class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-1">Time 1 (HHMMSS)</label>
            <input type="tel" id="time1" placeholder="123456" maxlength="6" pattern="[0-9]{6}" class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-1">Code 1</label>
            <input type="tel" id="code1" placeholder="Enter code" class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-1">Time 2 (HHMMSS)</label>
            <input type="tel" id="time2" placeholder="123456" maxlength="6" pattern="[0-9]{6}" class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-1">Code 2</label>
            <input type="tel" id="code2" placeholder="Enter code" class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
          </div>
        </div>
        <button onclick="findEffectiveOffset()" class="w-full py-3 px-4 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold text-lg shadow-lg hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105 btn-press">Find Offset</button>
        <div id="result-find-offset" class="result-container hidden bg-gray-700 p-4 rounded-lg border border-gray-600"></div>
      </div>

      <!-- Generate Barcode Tab -->
      <div id="generate-tab" class="tab-panel tab-panel-transition hidden space-y-5">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-1">Segment 1</label>
            <input type="text" id="seg1" placeholder="Enter seg1" inputmode="numeric" class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-1">Time (HHMMSS)</label>
            <input type="tel" id="timeGen" placeholder="123456" maxlength="6" pattern="[0-9]{6}" class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-1">Effective Offset</label>
            <input type="tel" id="offsetGen" placeholder="Enter offset" class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-1">Segment 5 (Cashier ID)</label>
            <input type="text" id="seg5" placeholder="Cashier ID" inputmode="numeric" class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
          </div>
          <div class="col-span-1 md:col-span-2">
            <label class="block text-sm font-medium text-gray-400 mb-1">Segment 6</label>
            <select id="seg6" class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
            </select>
          </div>
        </div>
        <button onclick="generateBarcode()" class="w-full py-3 px-4 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold text-lg shadow-lg hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105 btn-press">Generate Barcode</button>
        <div id="result-generate" class="result-container hidden bg-gray-700 p-4 rounded-lg border border-gray-600"></div>
        
        <div id="barcode-output" class="hidden flex flex-col items-center space-y-4 p-4 bg-gray-700 rounded-lg border border-gray-600">
            <div id="barcode-container" class="bg-white p-4 rounded-lg shadow-lg">
                <img id="barcodeImg" class="max-w-full h-auto rounded-md" alt="Generated Barcode">
            </div>
            <div class="flex space-x-2 w-full">
                <button onclick="copyToClipboard(generatedBarcodeCode, true)" class="flex-1 py-2 px-4 rounded-md bg-gray-600 text-white hover:bg-gray-500 transition-colors flex items-center justify-center btn-press">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path><path d="M6 7a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H8a2 2 0 01-2-2V7z"></path><path fill-rule="evenodd" d="M3 13V7a4 4 0 014-4h6a4 4 0 014 4v6a4 4 0 01-4 4H7a4 4 0 01-4-4zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path></svg>
                    Copy
                </button>
                <button onclick="downloadBarcode()" class="flex-1 py-2 px-4 rounded-md bg-gray-600 text-white hover:bg-gray-500 transition-colors flex items-center justify-center btn-press">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M13 10V3a1 1 0 10-2 0v7l-3-3a1 1 0 10-1.414 1.414l5 5a1 1 0 001.414 0l5-5A1 1 0 1016 7z"></path><path d="M12 15a1 1 0 100 2h2a2 2 0 002-2v-2a1 1 0 10-2 0v2zM5 13a1 1 0 100-2H3v2a2 2 0 002 2h2a1 1 0 100-2H5z"></path></svg>
                    Download
                </button>
            </div>
        </div>
      </div>

      <!-- History Tab -->
      <div id="history-tab" class="tab-panel tab-panel-transition hidden space-y-4">
        <h2 class="text-xl font-bold text-center">Recent Offsets</h2>
        <div class="flex items-end space-x-2">
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-400 mb-1">Select Date to Load</label>
                <input type="date" id="dateInput2" class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
            </div>
            <button onclick="loadFromDate()" class="py-3 px-4 rounded-md bg-purple-600 text-white hover:bg-purple-700 transition-colors btn-press">
                Load
            </button>
        </div>
        <div id="history-list" class="space-y-2">
          <!-- History items will be dynamically added here -->
          <p id="no-history" class="text-gray-400 text-center">No saved offsets found.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="w-full p-4 text-center text-sm text-gray-500 border-t border-gray-800">
    <p>&copy; 2025 BTTools. All Rights Reserved.</p>
    <p class="mt-1">Version 3.8.6</p>
  </footer>

  <script>
    // Tab switching and UI logic
    const tabButtons = document.querySelectorAll('[data-tab]');
    const tabPanels = document.querySelectorAll('.tab-panel');
    const tabContainer = document.getElementById('tab-container');
    const body = document.body;
    const themeToggle = document.getElementById('theme-toggle');
    const moonIcon = document.getElementById('moon-icon');
    const sunIcon = document.getElementById('sun-icon');
    
    let generatedBarcodeCode = '';
    const localStorageKey = 'bttools_offsets_history';

    // Function to get current date in YYYY-MM-DD format
    function getFormattedDate(date) {
        const d = date || new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    // Function to set the theme
    function setTheme(theme) {
        if (theme === 'light') {
            body.classList.add('light');
            moonIcon.classList.add('hidden');
            sunIcon.classList.remove('hidden');
        } else {
            body.classList.remove('light');
            moonIcon.classList.remove('hidden');
            sunIcon.classList.add('hidden');
        }
    }

    // Function to toggle the theme
    function toggleDarkMode() {
        const isLight = body.classList.contains('light');
        const newTheme = isLight ? 'dark' : 'light';
        setTheme(newTheme);
        localStorage.setItem('theme', newTheme);
    }

    function switchTab(targetTab) {
      const currentTab = document.querySelector('.tab-panel:not(.hidden)');
      const nextTab = document.getElementById(`${targetTab}-tab`);

      if (currentTab) {
        currentTab.classList.remove('opacity-100', 'translate-y-0');
        currentTab.classList.add('opacity-0', 'translate-y-2');
      }

      setTimeout(() => {
        tabButtons.forEach(btn => {
          if (btn.dataset.tab === targetTab) {
            btn.classList.add('bg-gray-700', 'text-gray-200');
            btn.classList.remove('hover:bg-gray-700');
          } else {
            btn.classList.remove('bg-gray-700', 'text-gray-200');
            btn.classList.add('hover:bg-gray-700');
          }
        });

        tabPanels.forEach(panel => {
          panel.classList.add('hidden');
        });

        if (nextTab) {
          nextTab.classList.remove('hidden');
          setTimeout(() => {
            nextTab.classList.add('opacity-100', 'translate-y-0');
          }, 10); // A slight delay to allow the hidden class to be removed first
        }
        
        // Load specific content for each tab
        if (targetTab === 'history') {
            loadHistory();
        }

      }, currentTab ? 300 : 0); // Delay matches the CSS transition time
    }

    // Helper functions
    function parseTime(str) {
      if (!str) return null;
      const s = str.trim();
      if (!/^\d{6}$/.test(s)) return null;
      return {
        H: +s.slice(0, 2),
        M: +s.slice(2, 4),
        S: +s.slice(4, 6)
      };
    }

    function toSeconds(t) {
      return t.H * 3600 + t.M * 60 + t.S;
    }

    function showModal(title, message, isError = false) {
      const modal = document.getElementById('messageModal');
      const modalContent = modal.querySelector('div');
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalMessage').textContent = message;

      if (isError) {
        tabContainer.classList.add('shake');
        modalContent.classList.add('border-red-500');
        setTimeout(() => tabContainer.classList.remove('shake'), 500);
      } else {
        modalContent.classList.remove('border-red-500');
      }

      modal.classList.remove('hidden');
      setTimeout(() => {
          modalContent.classList.remove('scale-95', 'opacity-0');
          modalContent.classList.add('scale-100', 'opacity-100');
      }, 10);
    }
    
    function hideModal() {
        const modal = document.getElementById('messageModal');
        const modalContent = modal.querySelector('div');
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    function showResult(elementId, content) {
      const element = document.getElementById(elementId);
      element.textContent = content;
      element.classList.remove('hidden');
    }

    // History and storage functions
    function getHistory() {
      try {
        const history = localStorage.getItem(localStorageKey);
        return history ? JSON.parse(history) : [];
      } catch (e) {
        return [];
      }
    }

    function saveOffsetToHistory(offset, date) {
        const history = getHistory();
        const dateString = getFormattedDate(date);
        
        const existingIndex = history.findIndex(item => item.date === dateString);
        if (existingIndex !== -1) {
            history[existingIndex].offset = offset;
        } else {
            history.push({ date: dateString, offset: offset });
        }
        
        history.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        const limitedHistory = history.slice(0, 10);
        localStorage.setItem(localStorageKey, JSON.stringify(limitedHistory));
    }

    function deleteRecord(date) {
        let history = getHistory();
        history = history.filter(item => item.date !== date);
        localStorage.setItem(localStorageKey, JSON.stringify(history));
        showModal('Record Deleted', `The offset for ${date} has been removed.`);
        loadHistory();
    }

    function loadHistory() {
        const history = getHistory();
        const historyList = document.getElementById('history-list');
        historyList.innerHTML = '';
        
        if (history.length === 0) {
            historyList.innerHTML = `<p id="no-history" class="text-gray-400 text-center">No saved offsets found.</p>`;
        } else {
            history.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center justify-between p-3 bg-gray-700 rounded-md border border-gray-600 history-item transition-colors duration-200';
                itemDiv.innerHTML = `
                    <div class="flex-1">
                        <div class="text-xs text-gray-400">${item.date}</div>
                        <div class="text-lg font-semibold">${item.offset}</div>
                    </div>
                    <div class="space-x-2">
                        <button onclick="prefillFromHistory('${item.date}', ${item.offset})" class="py-1 px-3 rounded-md bg-purple-600 text-white text-sm hover:bg-purple-700 transition-colors btn-press">Load</button>
                        <button onclick="deleteRecord('${item.date}')" class="py-1 px-3 rounded-md bg-red-600 text-white text-sm hover:bg-red-700 transition-colors btn-press">Delete</button>
                    </div>
                `;
                historyList.appendChild(itemDiv);
            });
        }
    }
    
    function loadFromDate() {
        const selectedDate = document.getElementById('dateInput2').value;
        if (!selectedDate) {
            showModal('Error', 'Please select a date to load.', true);
            return;
        }

        const history = getHistory();
        const record = history.find(item => item.date === selectedDate);
        if (record) {
            prefillFromHistory(record.date, record.offset);
        } else {
            showModal('Not Found', `No saved offset found for ${selectedDate}.`);
        }
    }

    function prefillFromHistory(date, offset) {
      document.getElementById('dateInput2').value = date;
      document.getElementById('timeGen').value = '';
      document.getElementById('offsetGen').value = offset;
      
      showModal('Loaded', `Offset ${offset} for ${date} has been loaded.`);
      switchTab('generate');
    }

    // Tab 1: Find Effective Offset
    function findEffectiveOffset() {
      const selectedDate = document.getElementById('dateInput1').value;
      const t1 = parseTime(document.getElementById('time1').value);
      const c1 = +document.getElementById('code1').value.trim();
      const t2 = parseTime(document.getElementById('time2').value);
      const c2 = +document.getElementById('code2').value.trim();

      if (!selectedDate || !t1 || !t2 || isNaN(c1) || isNaN(c2)) {
        showModal('Error', 'Please fill all fields with valid values.', true);
        return;
      }

      const s1 = toSeconds(t1);
      const s2 = toSeconds(t2);
      const off1 = c1 - s1;
      const off2 = c2 - s2;

      if (off1 !== off2) {
        showModal('Error', `Offsets differ! Offset 1: ${off1}, Offset 2: ${off2}. Cannot find a single effective offset.`, true);
      } else {
        saveOffsetToHistory(off1, new Date(selectedDate));
        prefillFromHistory(selectedDate, off1);
        showResult('result-find-offset', `Effective Offset: ${off1}`);
      }
    }

    // Tab 2: Generate Barcode
    function generateBarcode() {
      const seg1 = document.getElementById('seg1').value.trim();
      const t = parseTime(document.getElementById('timeGen').value);
      const off = +document.getElementById('offsetGen').value.trim();
      const seg5 = document.getElementById('seg5').value.trim();
      const seg6 = document.getElementById('seg6').value.trim();

      if (!t || isNaN(off)) {
        showModal('Error', 'Please provide valid time and offset values.', true);
        return;
      }

      const s = toSeconds(t);
      const seg2 = s + off;
      const seg3 = '000';
      const hh = String(t.H);
      const mm = String(t.M).padStart(2, '0');
      const ss = String(t.S).padStart(2, '0');
      const seg4 = (hh + mm + ss).replace(/^0+/, '');
      generatedBarcodeCode = seg1 + String(seg2).padStart(6, '0') + seg3 + seg4 + seg5 + seg6;
      
      showResult('result-generate', `Generated Code: ${generatedBarcodeCode}`);
      
      const barcodeImg = document.getElementById('barcodeImg');
      barcodeImg.src = `https://barcode.orcascan.com/?type=code128&data=${encodeURIComponent(generatedBarcodeCode)}`;
      document.getElementById('barcode-output').classList.remove('hidden');
      
      barcodeImg.onload = () => {
        barcodeImg.classList.remove('animate-pulse');
      };
      
      barcodeImg.classList.add('animate-pulse');
    }

    // Copy to clipboard utility function
    function copyToClipboard(text, showFeedback = true) {
      if (!text) return;
      
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed";
      textArea.style.left = "-999999px";
      textArea.style.top = "-999999px";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        document.execCommand('copy');
        if (showFeedback) {
          showModal('Success', 'Barcode code copied to clipboard!');
        }
      } catch (err) {
        showModal('Error', 'Could not copy text to clipboard.', true);
      } finally {
        document.body.removeChild(textArea);
      }
    }

    // Download barcode as PNG
    function downloadBarcode() {
      const barcodeImg = document.getElementById('barcodeImg');
      if (!barcodeImg.src) {
        showModal('Error', 'No barcode to download.', true);
        return;
      }

      // Create a new image element to handle potential CORS issues
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        
        const link = document.createElement('a');
        link.download = `barcode_${generatedBarcodeCode || new Date().getTime()}.png`;
        link.href = canvas.toDataURL('image/png');
        
        document.body.appendChild(link);
        // Try to trigger the download programmatically
        try {
          link.click();
          document.body.removeChild(link);
        } catch (e) {
          // If programmatic download fails (common on mobile), use alternative method
          document.body.removeChild(link);
          downloadBarcodeAlternative();
        }
      };
      img.onerror = () => {
        showModal('Error', 'Failed to download barcode image. It might be due to a CORS policy.', true);
      };
      img.src = barcodeImg.src;
    }

    // Alternative download method for mobile
    function downloadBarcodeAlternative() {
      const barcodeImg = document.getElementById('barcodeImg');
      if (barcodeImg.src) {
        showModal('Download Barcode', 'Tap "OK" to open the barcode in a new tab. You can then long-press and save the image to your device.', false);
        window.open(barcodeImg.src, '_blank');
      } else {
        showModal('Error', 'No barcode to download.', true);
      }
    }

    // Initial setup
    document.addEventListener('DOMContentLoaded', () => {
      // Set default date to today
      const today = getFormattedDate();
      document.getElementById('dateInput1').value = today;
      document.getElementById('dateInput2').value = today;

      // Check for saved theme preference
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
          setTheme(savedTheme);
      } else {
          // Default to dark mode if no preference is set
          setTheme('dark');
      }

      // Add event listeners
      themeToggle.addEventListener('click', toggleDarkMode);

      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const targetTab = button.dataset.tab;
          switchTab(targetTab);
        });
      });

      // Add initial classes for animation
      tabPanels.forEach(panel => {
        panel.classList.add('tab-panel-transition', 'opacity-0', 'translate-y-2');
      });
      document.getElementById('find-offset-tab').classList.remove('hidden');
      setTimeout(() => {
        document.getElementById('find-offset-tab').classList.add('opacity-100', 'translate-y-0');
      }, 10);
    });

    // Add haptic feedback for mobile devices
    if ('vibrate' in navigator) {
      document.querySelectorAll('button').forEach(button => {
        button.addEventListener('click', () => {
          navigator.vibrate(50);
        });
      });
    }

    // Prevent zoom on double tap for iOS
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
  </script>
</body>
</html>
